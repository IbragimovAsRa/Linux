# Сети в Linux.
Настройка сетей в Linux на виртуальных машинах.


## Часть 1. Инструмент ipcalc
### 1.1. Сети и маски
Информацию об `ip` можно получить вызвав команду `ipcalc`: \
![вызов команды ipcalc](media/img_1.png)

#### 1.1.1. Определение адреса сети
Для того чтобы узнать адрес сети хоста с `IP` `192.167.38.54/13` требуется поразрядно перемножножить двоичные представления маски подсети и `IP`-адреса какого-либо хоста той же сети. 
    
Адрес сети хоста `192.160.0.0/13`.

#### 1.1.2. Различные формы представления масок

| Обычная | Префиксная | Двоичная |
| --------| ---------- |--------- |
| 255.255.255.0 | /24 | 11111111.11111111.11111111.00000000 |
| 255.254.0.0 | /15 | 11111111.1111111 0.00000000.00000000 |
| 255.255.255.240 | /28 | 11111111.11111111.11111111.11110000 |

#### 1.1.3. Минимальные, максимальные размеры хостов

`IP` хоста в сети `12.167.38.4`, маска `/8`: \
![max, min при маске /8](media/img_2.png)

`IP` хоста в сети `12.167.38.4`, маска `11111111.11111111.00000000.00000000`: \
![max, min при маске 11111111.11111111.00000000.00000000](media/img_3.png)

`IP` хоста в сети `12.167.38.4`, маска `255.255.254.0`: \
![max, min при маске 255.255.254.0](media/img_4.png)

`IP` хоста в сети `12.167.38.4`, маска `/4`: \
![max, min при маске /4](media/img_5.png)

### 1.2. localhost

`IP` адреса к которым можно обратиться по `localhost`: `127.0.0.2`, `127.1.0.1`. \
![Индикатор принадлежности к `localhost`](media/img_6.png)

`IP` адреса к которым нельзя обратиться по `localhost`: \
`194.34.23.100` \
![Отсутствие идикатора принадлежности к localhost](media/img_7.png)

`128.0.0.1` \
![Отсутствие идикатора принадлежности к localhost](media/img_8.png)


### 1.3. Диапазоны и сегменты сетей

*Частный `IP`-адрес (Private `IP` address)* - это адрес, который используется для идентификации устройства в локальной сети. Он предназначен для использования внутри частных сетей и не маршрутизируется через интернет.\
*Публичный `IP`-адрес (Internet Protocol address)* - это уникальный идентификатор, присвоенный устройству в сети Интернет. Он используется для обмена данных между устройствами в глобальной сети.\
Диапазоны частных `IP` адресов: 
- Класс А: `10.0.0.0` – `10.255.255.255`
- Класс Б: `172.16.0.0` – `172.31.255.255`
- Класс С: `192.168.0.0` – `192.168.255.255`

*Шлюз (gateway)* - это сетевое устройство, которое обеспечивает связь между различными сетевыми сегментами или сетями. Он выполняет роль промежуточного узла, через который проходит сетевой трафик между сетями.

#### 1.3.1. Классификация `IP` адресов

К публичным относятся следующие `IP` адреса: \
  `134.43.0.2` \
![публичный IP адрес](media/img_9.png)

 `172.0.2.1` \
![публичный IP адрес](media/img_9.png)

 `192.172.0.1` \
![публичный IP адрес](media/img_10.png)

 `172.68.0.2` \
![публичный IP адрес](media/img_9.png)

 `192.169.168.1` \
![публичный IP адрес](media/img_10.png)

К частным относятся следующие `IP` адреса: \
`10.0.0.45` \
![частный IP адрес](media/img_11.png)

`192.168.4.2` \
![частный IP адрес](media/img_12.png)

`172.20.250.4` \
![частный IP адрес](media/img_13.png)

`172.16.255.255` \
![частный IP адрес](media/img_13.png)

`10.10.10.10` \
![частный IP адрес](media/img_11.png)

#### 1.3.2. Доступные `IP` адреса шлюза
Диапазон `IP` адресов шлюза сети `10.10.0.0/18`:

![диапазон IP  адресов шлюза сети](media/img_14.png)

Из перечисленных ему доступны следующие `IP` адреса из перечисленных: `10.10.0.2`, `10.10.10.10`, `10.10.1.255`.

## Часть 2. Статическая маршрутизация между двумя машинами

*Маршрутизация (Routing)* - это процесс передачи данных в сети от отправителя к получателю через промежуточные узлы, называемые маршрутизаторами или шлюзами. Она является основной функцией сетевых устройств, которые обеспечивают связь между различными сетями.

*Статическая маршрутизация (Static Routing)* - это метод установки маршрутов в сети вручную, вручную указывая конкретные пути для передачи пакетов данных. При использовании статической маршрутизации сетевой администратор явно определяет маршруты в таблице маршрутизации каждого маршрутизатора или сетевого устройства.
### 2.0. Настройка машин

Существующие сетевые интерфейсы `ws1`: \
![сетевые интерфейсы ws1](media/img_15.png)

Существующие сетевые интерфейсы `ws2`: \
![сетевые интерфейсы ws2](media/img_16.png)



Настройка сетевых интерфейсов `ws1`: \
![конфигурационный файл ws1](media/img_17.png)

Настройка сетевых интерфейсов `ws2`: \
![конфигурационный файл ws2](media/img_18.png)

Приминение настроеной конфигурации для `ws1`: \
![приминение настроеной конфигурации для ws1](media/img_19.png)

Приминение настроеной конфигурации для `ws2`: \
![приминение настроеной конфигурации для ws2](media/img_20.png)

Сетевые интерфейсы после настройки:

Сетевые интерфейсы `ws1`: \
![сетевые интерфейсы ws1](media/img_23.png)

Сетевые интерфейсы `ws2`: \
![сетевые интерфейсы ws1](media/img_24.png)


### 2.1. Добавление статического маршрута вручную

Настройка статического маршрута вручную для `ws1`: \
![настройка статического маршрута для ws1](media/img_21.png)

Настройка статического маршрута вручную для `ws2`: \
![настройка статического маршрута для ws2](media/img_22.png)


### 2.2. Добавление статического маршрута с сохранением

Настройка статического маршрута с сохранением для `ws1`: \
![настройка статического маршрута для ws1](media/img_25.png)

Настройка статического маршрута с сохранением для `ws2`: \
![настройка статического маршрута для ws2](media/img_26.png)


Проверка соединения (пинг):

`ws1` пинг `ws2`\
![ws1 пинг ws2](media/img_27.png)

`ws2` пинг `ws1`\
![ws2 пинг ws1](media/img_28.png)


## Часть 3. Утилита iperf3
*`Iperf3`* — это инструмент для измерения пропускной способности сети, который позволяет оценить пропускную способность и характеристики сетевого соединения между двумя узлами. Он является потомком популярного инструмента `iperf`, который предоставлял аналогичные функции.

`Iperf3` работает в клиент-серверной модели, где один узел выступает в роли сервера, а другой — в роли клиента. Клиент генерирует сетевой трафик и отправляет его на сервер, который затем измеряет пропускную способность, задержку и другие параметры соединения.

`Iperf3` может быть использован для различных целей, включая:
- Измерение пропускной способности сети между двумя узлами.
- Оценка задержки (пинга) и потерь пакетов в сети.
- Тестирование и настройка сетевых устройств и маршрутизаторов.
- Оптимизация настроек сети для достижения наилучшей производительности.


### 3.1. Скорость соединения

- 8 Mbps = 1 MB/s 
- 100 MB/s  = 800 000 Kbps
- 1 Gbps = 1 000 Mbps
### 3.2. Утилита iperf3

Для измерения скорости соединения между машинами `ws1` и `ws2`, 
машина `ws1` запускается в режиме сервера, а машина `ws2` в режиме клиента: \
`ws1` (сервер) \
![ws1 (сервер)](media/img_29.png)

`ws2` (клиент) \
![ws2 (клиент)](media/img_30.png)

## Часть 4. Сетевой экран
*Сетевой экран (англ. firewall)* - это система, которая используется для защиты компьютерной сети или отдельных узлов от несанкционированного доступа и потенциально вредоносной активности. Он представляет собой барьер, контролирующий поток сетевого трафика и решающий, какие пакеты данных разрешены или блокируются на основе определенных правил и настроек.

*`Iptables`* - это утилита командной строки в Linux, которая предоставляет интерфейс для настройки и управления сетевым экраном (firewall) в ядре Linux. `Iptables` является частью подсистемы Netfilter, которая предоставляет возможности фильтрации и манипулирования сетевыми пакетами в Linux.

*`Nmap` (Network Mapper)* - это утилита сканирования сети, которая используется для исследования и проверки безопасности компьютерных сетей. Она предоставляет возможность анализировать хосты и порты в сети, определять открытые порты, определять операционные системы, обнаруживать службы и многое другое.
### 4.1. Утилита iptables

Содержание настроенного файла конфигурации `/etc/firewall.sh` на машине `ws1`:

![файл /etc/firewall.sh на машине ws1](media/img_31.png)


Содержание настроенного файла конфигурации `/etc/firewall.sh` на машине `ws2`:

![файл /etc/firewall.sh на машине ws2](media/img_32.png)

Результат запуска файла `/etc/firewall.sh` на машине `ws1`:

![запуск файла /etc/firewall.sh на машине ws1](media/img_33.png)


Результат запуска файла `/etc/firewall.sh` на машине `ws2`:

![запуск файла /etc/firewall.sh на машине ws2](media/img_34.png)


Различие между стратегиями, примененными в первом и втором файлах, заключается в следующем: в случае использования утилиты `iptables`, правила выполняются в порядке, идущем сверху вниз. На первой машине в файле сначала указано запрещающее правило для исходящих соединений, что означает, что она не сможет выполнить пинг до другой машины. В то же время, на второй машине первым указано разрешающее правило, что означает, что она сможет выполнить пинг до другой машины.


### 4.2. Утилита nmap
`ws1` пинг `ws2`: \
![ws1` пинг ws2](media/img_35.png)
`ws2` пинг `ws1`: \
![ws2 пинг ws1](media/img_36.png)

В firewall.sh файле для второй машины в начале было добавлено запрещающее правило, из-за чего невозможно выполнить пинг до нее. \
Для подтверждения того, что хост машины работает, воспользуемся инструментом `nmap`:

![проверка ws2](media/img_37.png)


## Часть 5. Статическая маршрутизация сети


![структура настраиваемой сеть](media/img_38.png)


### 5.1. Настройка адресов машин

Настройка конфигурации машины `r1`: \
![конфигурация машины r1](media/img_39.png)


Настройка конфигурации машины `r2`: \
![конфигурация машины r2](media/img_40.png)


Настройка конфигурации машины `w11`: \
![конфигурация машины w11](media/img_41.png)


Настройка конфигурации машины `w21`: \
![конфигурация машины w21](media/img_42.png)



Настройка конфигурации машины `w22`: \
![конфигурация машины w22](media/img_43.png)

Проверка правильности настроек конфигурации: 

`r1`\
![r1](media/img_44.png)


`r2`\
![r2](media/img_45.png)


`w11`\
![w11](media/img_46.png)


`w21`\
![w21](media/img_47.png)


`w22`\
![w22](media/img_48.png)

Пинг `ws22` с `ws21`: \
![пинг ws22 с ws21](media/img_49.png)


Пинг `r1` с `ws11`: \
![пинг r1 с ws11](media/img_50.png)

### 5.2. Включение переадресации IP-адресов

Включение переадресации без сохранения: \
![переадресация без сохранения r1](media/img_51.png)

![переадресация без сохранения r2](media/img_52.png)


Включение переадресации c сохранением изменений: \
![переадресация c сохранением изменений](media/img_53.png)


### 5.3. Установка маршрута по-умолчанию
Настройка маршрута по-умолчанию (шлюз) для рабочих станций:\
`w11`\
![маршрута по-умолчанию (шлюз) для w11](media/img_54.png)

`w21`\
![маршрута по-умолчанию (шлюз) для w21](media/img_55.png)

`w22`\
![маршрута по-умолчанию (шлюз) для w22](media/img_56.png)

Проверка добавления маршрута в таблицу маршрутизации:\
`w11`\
![таблица маршрутизации w11](media/img_57.png)

`w21`\
![таблица маршрутизации (шлюз) для w21](media/img_58.png)

`w22`\
![таблица маршрутизации (шлюз) для w22](media/img_59.png)


Пинг с `ws11` роутера `r2`:\

Машина `ws11`\
![пинг r2](media/img_60.png)

Машина `r2`\
![пинг r2](media/img_61.png)

Ответ на пинг не доходит до машины `ws11`,так как машина `r2` не знает по какому адресу отправить ответ, но пинги до `r2` доходят.\

### 5.4. Добавление статических маршрутов
Настройка `r1`:\
![настройка r1](media/img_62.png)

Настройка `r2`:\
![настройка r2](media/img_63.png)

Таблица маршрутизации `r1`:\
![таблица маршрутизации r1](media/img_64.png)

Таблица маршрутизации `r2`:\
![таблица маршрутизации r2](media/img_65.png)

Маршрутизация `w11`:\
![маршрутизация w11](media/img_66.png)


Для адреса `10.10.0.0/18` был выбран маршрут, отличный от `0.0.0.0/0` (он попадает под маршрут по-умолчанию), т.к. машина `ws11` соединена с сетью `10.10.0.0/18` по своему IP-адресу `10.10.0.2`, для других адресов используется маршрут по умолчанию, который указан в файле `10.10.0.1`.



### 5.5. Построение списка маршрутизаторов
Список маршрутизаторов на пути от `ws11` до `ws21`:\
![w11](media/img_67.png)

Результат работы дампа на `r1`:\
![r1](media/img_68.png)


*Traceroute (или трассировка маршрута)* - это утилита, которая позволяет определить путь, который сетевой пакет проходит от отправителя к получателю через сеть. Она основана на использовании ICMP пакетов (Internet Control Message Protocol) и TTL (Time to Live) поля в заголовке IP пакетов.

Принцип работы traceroute следующий:

1. Traceroute отправляет специально сформированные ICMP Echo Request пакеты с постепенно увеличающимся значением TTL в заголовке IP пакета.

2. TTL представляет собой счетчик, который указывает, сколько маршрутизаторов может пройти пакет, прежде чем он будет отброшен. Изначально TTL установлен на 1.

3. Когда пакет достигает первого маршрутизатора на пути, TTL уменьшается на 1, и маршрутизатор отправляет обратно ICMP Time Exceeded сообщение отправителю. Это сообщение указывает, что пакет не может дальше продвигаться из-за достижения предела TTL.

4. Отправитель, получив Time Exceeded сообщение, знает, что первый маршрутизатор на пути был найден, и записывает IP-адрес этого маршрутизатора.

5. Traceroute повторяет этот процесс, каждый раз увеличивая значение TTL на 1, чтобы найти следующий маршрутизатор на пути к конечному пункту назначения.

6. Когда ICMP Echo Request пакет достигает конечного пункта назначения, получатель отправляет ICMP Echo Reply пакет обратно отправителю.

7. Таким образом, отправитель может отслеживать путь до конечного пункта назначения, записывая IP-адреса промежуточных маршрутизаторов, отвечающих на ICMP Time Exceeded сообщения.

8. Traceroute продолжает этот процесс до достижения максимального количества прыжков (hops) или до получения ICMP Echo Reply от конечного пункта назначения.

В результате traceroute строит список IP-адресов промежуточных маршрутизаторов и измеряет время, затраченное на прохождение пакетов через каждый маршрутизатор. Это позволяет определить задержки и проблемы в сети на пути от отправителя к получателю.

### 5.6. Использование протокола ICMP при маршрутизации

Перехват пакетов на `r1`:\
![r1](media/img_69.png)

Пинг с `ws11`:\
![ws11](media/img_70.png)


## Часть 6. Динамическая настройка IP с помощью DHCP


*`DHCP` (Dynamic Host Configuration Protocol)* - это сетевой протокол, который позволяет компьютерам и другим сетевым устройствам автоматически получать `IP`-адрес, настройки сети и другие параметры сетевой конфигурации от `DHCP`-сервера.

Основная цель `DHCP` - облегчить процесс настройки сети для устройств, подключающихся к сети. Вместо того, чтобы вручную настраивать `IP`-адрес, подсеть, шлюз по умолчанию и другие параметры для каждого устройства вручную, `DHCP` автоматически назначает эти значения устройствам, когда они подключаются к сети.

### 6.1. Настройка службы DHCP
Настройка адреса маршрутизатора по-умолчанию, DNS-сервера и адреса внутренней сети на машине `r2`: 

![r2](media/img_71.png)

![r2](media/img_72.png)

Перезагрузка службы `DHCP`:\
![r2](media/img_73.png)

Настройка конфигурации `ws21`:\
![ws21](media/img_74.png)

Настройка конфигурации `ws22`:\
![ws22](media/img_75.png)

Проверка получения `IP` адресса:\
`ws21`\
![ws21](media/img_76.png)

`ws22`\
![ws22](media/img_77.png)

Проверка соединения между `ws21` и `ws22`:\
![ws21 пинг ws22](media/img_78.png)

### 6.2. MAC-адрес
Настройка MAC-адресса:\
`w11`\
![ws11](media/img_79.png)

Настройка `r1` с выдачей адресов  с жесткой привязкой к MAC-адресу (ws11):\
Файл /etc/dhcp/dhcpd.conf\
![r1](media/img_80.png)

Файл /etc/resolv.conf\
![r1](media/img_81.png)

Статус сервиса `isc-dhcp-server`:\
![isc-dhcp-server](media/img_82.png)

Проверка корректного назначения `ip` машине `ws11`:\
![ws11](media/img_83.png)

Проверка соединения (`ws22` пингует `ws11`):\
![ws22](media/img_84.png)


### 6.3. Обновление `ip` 

`IP` машины `ws21` до обновления:\
![ws21](media/img_85.png)


Удаление старого `ip`:\
![ws21](media/img_87.png)

`IP` машины `ws21` после обновления:\
![ws21](media/img_86.png)


Были применены следующие опции DHCP протокола:

- Опция routers `ip-address` - указывает адреса шлюзов для клиентской сети. Список маршрутизаторов должен быть упорядочен по предпочтительности.
- Опция `domain-name-servers ip-address`  - перечисляет доступные клиенту DNS серверы. Серверы должны быть упорядочены по приоритету.


## Часть 7. NAT
*SNAT (Source Network Address Translation)* - это технология, используемая в компьютерных сетях для изменения и перевода исходного `IP`-адреса отправляемых сетевых пакетов. Она является одной из форм Network Address Translation (`NAT`).

`SNAT` применяется на маршрутизаторах или брандмауэрах и позволяет изменять исходный `IP`-адрес пакетов, проходящих через него, перед отправкой их на удаленный узел в сети. Это полезно, когда устройства в локальной сети с использованием приватных `IP`-адресов нуждаются в доступе к ресурсам во внешней сети, такой как Интернет.

Когда пакет проходит через устройство с настроенным `SNAT`, исходный `IP`-адрес в заголовке пакета заменяется на публичный `IP`-адрес, присвоенный устройству для коммуникации с внешней сетью. Это позволяет устройствам с приватными `IP`-адресами отправлять пакеты во внешнюю сеть и получать ответы обратно.

### 7.1. Настройка сервера Apache2

Настройка конфигурационного файла на машинах  `w22` и `r1`:\
![ws22 и r1](media/img_88.png)

Запуск веб-сервера на машинах `w22` и `r1`:\
машина `w22`\
![ws22](media/img_89.png)

машина `r1`\
![r1](media/img_90.png)


### 7.2. Настройка фаервола на r2

Создание фаервола на мащине `r2`:\

файл `/etc/faerwall.sh`\
![r2](media/img_91.png)

Запуск фаервола:\
![r2](media/img_92.png)

Проверка работы фаервола (пинг `ws22` с `r1`):\
![r1](media/img_93.png)


Проверка работы фаервола (пинг `r1` с `ws22` ):\
![ws22](media/img_94.png)

Настройка  разрешения маршрутизации всех пакетов протокола ICMP:\
Машина `r2`, файл `/etc/firewall.sh`\
![r2](media/img_95.png)

Запуск фаервола:\
![r2](media/img_96.png)

Проверка работы фаервола (пинг `ws22` с `r1`):\
![ws22](media/img_97.png)

Проверка работы фаервола (пинг `r1` с `ws22` ):\
![ws22](media/img_98.png)

Пинги между машинами проходят, значит фаервол на `r2` успешно их пропускает.


### 7.3. Настройка SNAT и DNAT

Для настройки понадобится добавить еще 2 правила в фаервол:

Машина `r2`, файл `/etc/faerwall.sh`\
![r2](media/img_99.png)


Запуск фаервола:\
![r2](media/img_100.png)


Проверка соединения по `TCP` для `SNAT` (с `ws22` подключение к серверу `Apache` на `r1`):\
![w22](media/img_101.png)

Проверить подмену `IP`-адреса можно с помощью команды `tcpdump` - пингуем с машины `ws22` роутер `r1`, в выводе `tcpdump` будет отображаться с какого адреса идет запрос - `IP`-адрес `r2`.


![w22](media/img_102.png)

![r1](media/img_103.png)

## Часть 8. Дополнительно. Знакомство с SSH Tunnels

Настройка конфигурации `apache2`:\
Машина `w22`\
![w22](media/img_104.png)



